@page "/Service/CustomerLookup"
@using Microsoft.AspNetCore.Authorization
@using ProjectWebApp.Components.Dialogues

@attribute [Authorize]

<PageTitle>Customer Search</PageTitle>

<MudText Typo="Typo.h4">Customer Search</MudText>

<AuthorizeView Roles="Mechanic,Parts Manager,Admin - All Roles">
    <NotAuthorized>
        <MudText Typo="Typo.h6" Color="Color.Error">
            You do not have access to this content. Only Mechanics, Shop
            Managers and Admin can access the servicing system.
        </MudText>
    </NotAuthorized>
    <Authorized>
        <DMITMessageDisplay ErrorMessage="@errorMessage" ErrorMsgs="@errorDetails" Feedback="@feedback" />

        <MudStack Class="mt-4">
            <MudText Typo="Typo.h6">Customer Search</MudText>
            <MudGrid>
                <MudItem sm="12" md="6">
                    <MudTextField @bind-Value="lastName" Label="Last Name" Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>

            <MudStack Row>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="Search" Disabled="!isAuthorized">
                    Search
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Clear" Disabled="!isAuthorized">
                    Clear
                </MudButton>
            </MudStack>
        </MudStack>

        <MudDataGrid Items="Customers" Striped Dense Class="mt-2" FixedHeader="true" FixedFooter="true" Height="30vh"
            Hover="true">
            <Columns>
                <TemplateColumn>
                    <CellTemplate Context="cellContext">
                        <MudButton Variant="Variant.Text" Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.PersonAdd" OnClick="() => SelectCustomer(cellContext.Item)">
                        Select
                        </MudButton>
                        </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.Name" Title="Name" />
                <PropertyColumn Property="x => x.Phone" Title="Phone" />
                <PropertyColumn Property="x => x.Address" Title="Address" />
            </Columns>

            <NoRecordsContent>
                <MudText Typo="Typo.h6">
                    @((noRecords ? "No customers found." : "Please search for customers."))
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudDataGridPager />
            </PagerContent>
        </MudDataGrid>

        @if (SelectedCustomer != null && SelectedCustomer.Id > 0)
        {
            <MudGrid Class="mt-4">
                <MudItem sm="12" md="6">
                    <MudPaper Elevation="2" Class="pa-2" Height="250px">
                        <MudStack>
                            <MudText Typo="Typo.h6" Align="Align.Center">
                                <strong>Selected Customer</strong>
                            </MudText>
                            <MudText Typo="Typo.body1" Align="Align.Center">
                                <strong>Name: </strong>@SelectedCustomer.Name
                            </MudText>
                            <MudText Typo="Typo.body1" Align="Align.Center">
                                <strong>Phone: </strong>@SelectedCustomer.Phone
                            </MudText>
                            <MudText Typo="Typo.body1" Align="Align.Center">
                                <strong>Address: </strong>@SelectedCustomer.Address
                            </MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem sm="12" md="6">
                    <MudPaper Elevation="2" Class="pa-2" Height="250px">
                        <MudStack>
                            <MudText Typo="Typo.h6" Align="Align.Center">
                                <strong>Vehicle Selection</strong>
                            </MudText>
                            <MudSelect Label="Select Vehicle" @bind-Value="selectedVehicleId">
                                @foreach (var vehicle in SelectedCustomer.Vehicles)
                                {
                                    <MudSelectItem Value="vehicle.VehicleIdentification">
                                        @vehicle.Make @vehicle.Model
                                    </MudSelectItem>
                                }
                            </MudSelect>
                            <MudTextField Label="VIN" @bind-Value="selectedVehicleId" ReadOnly="true" />
                        </MudStack>

                        @if (!string.IsNullOrEmpty(selectedVehicleId))
                        {
                            <MudStack Class="mt-4" Row AlignItems="AlignItems.Center" Justify="Justify.Center">
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large"
                                    OnClick="NavigateToServiceScreen">
                                    Go to Service Screen
                                </MudButton>
                            </MudStack>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }
    </Authorized>
</AuthorizeView>