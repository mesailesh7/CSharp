@page "/returns"

@using MudBlazor
@using SalesReturnsSystem.ViewModels
@* @inject NavigationManager Nav *@
@* @inject SalesReturnsSystem.BLL.ReturnService ReturnService
@inject SalesReturnsSystem.BLL.ReturnTransactionService TxService *@

<MudText Typo="Typo.h5" Class="mb-2">Invoice Search</MudText>

<MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-1">
    <MudText>Sales Invoice #:</MudText>
    <MudTextField @bind-Value="InvoiceNumberText"
                  Variant="Variant.Outlined"
                  Dense="true"
                  Style="width:180px" />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Search">SEARCH</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="ClearSearch">CLEAR</MudButton>
   
</MudStack>

@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Dense="true" Class="mt-1 mb-3">
        @ErrorMessage
    </MudAlert>
}
@if (!string.IsNullOrWhiteSpace(Feedback))
{
    <MudAlert Severity="Severity.Success" Dense="true" Class="mt-1 mb-3">
        @Feedback
    </MudAlert>
}

@if (Model is not null)
{
    <!-- 2) Sale Information -->
    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mt-4 mb-1"> Sale Information</MudText>

    <MudSimpleTable Dense="true" Bordered="true">
        <thead>
            <tr>
                <th>Field</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Sale Invoice #</td>
                <td>@Model.SaleId</td>
            </tr>
            <tr>
                <td>Customer</td>
                <td>@Model.CustomerName</td>
            </tr>
            <tr>
                <td>Date</td>
                <td>@Model.SaleDate.ToString("MMM dd, yyyy")</td>
            </tr>
            <tr>
                <td>Discount %</td>
                <td>@Model.DiscountPercent.ToString("P0")</td>
            </tr>
            <tr>
                <td>Payment Method</td>
                <td>@Model.PaymentMethod</td>
            </tr>
        </tbody>
    </MudSimpleTable>

    <!-- 3) Sale Parts -->
    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mt-4 mb-1"> Sale Parts</MudText>

    <MudDataGrid T="SaleReturnItemViewModel"
                 Items="Model.Items"
                 Striped="true"
                 Dense="true"
                 FixedHeader="true"
                 Height="360px">

        <Columns>
            <PropertyColumn Property="x => x.PartName" Title="Part Name" />
            <PropertyColumn Property="x => x.OriginalQty" Title="Orig Qty" />
            <PropertyColumn Property="x => x.AlreadyReturned" Title="Returned" />

            <TemplateColumn Title="Price">
                <CellTemplate Context="cell">
                    <MudText>@cell.Item.Price.ToString("C")</MudText>
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Refundable">
                <CellTemplate Context="cell">
                    <MudText>@(cell.Item.Refundable ? "Y" : "N")</MudText>
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Qty to Return">
                <CellTemplate Context="cell">
                    @if (cell.Item.Refundable && (cell.Item.OriginalQty - cell.Item.AlreadyReturned) > 0)
                    {
                        <MudNumericField @bind-Value="cell.Item.QtyToReturn"
                                         Min="0"
                                         Max="@(cell.Item.OriginalQty - cell.Item.AlreadyReturned)"
                                         Step="1"
                                         Dense="true"
                                         Immediate="true" />
                    }
                    else
                    {
                        <MudText>0</MudText>
                    }
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Reason">
                <CellTemplate Context="cell">
                    @if (cell.Item.Refundable && cell.Item.QtyToReturn > 0)
                    {
                        <MudTextField @bind-Value="cell.Item.Reason"
                                      Placeholder="Enter reason"
                                      Dense="true" />
                    }
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>

    <!-- Totals (matches your earlier layout) -->
    <MudText Typo="Typo.body2" Class="mt-2">
        <strong>Subtotal:</strong> @Model.Subtotal.ToString("C") &nbsp;
        <strong>Discount:</strong> @Model.Discount.ToString("C") &nbsp;
        <strong>Tax:</strong> @Model.Tax.ToString("C") &nbsp;
        <strong>Total:</strong> @Model.Total.ToString("C")
    </MudText>

    <!-- 4) Actions -->
    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mt-4 mb-1"> Actions</MudText>

    <MudStack Row="true" Spacing="2" Class="mt-1">
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="@(!CanProcess || IsWorking || IsProcessed)"
                   OnClick="ProcessReturn">
            Process Return
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Error"
                   OnClick="Cancel">
            Cancel
        </MudButton>
    </MudStack>
}

<style>
    .mud-table th {
        background-color: #e7f3ff !important;
    }
</style>
